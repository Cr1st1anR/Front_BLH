<p-toast position="top-right" key="tr" />

@if (loading) {
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
  <p-progress-spinner strokeWidth="8" fill="transparent" animationDuration="2s"
    [style]="{ width: '70px', height: '70px' }"></p-progress-spinner>
</div>
}

<div class="flex flex-col items-center justify-center mx-auto my-6 max-w-7xl">
  <p-table #tableCrematocrito [value]="dataCrematocrito" [scrollable]="true" scrollHeight="400px"
    [columns]="headersCrematocrito" [tableStyle]="{ 'min-width': '60rem', 'max-width': '90rem' }" dataKey="id"
    editMode="row">

    <ng-template #header let-columns>
      <tr>
        @for (col of columns; track $index) {
        <th class="grid-lines" [class.header-group]="col.tipo === 'group-header'">
          {{ col.header }}
        </th>
        }
      </tr>
    </ng-template>

    <ng-template #body let-rowData let-columns="columns" let-editing="editing" let-rowIndex="rowIndex">
      <tr [pEditableRow]="rowData">
        @for (col of columns; track $index) {
        <td>
          <!-- CAMPOS CT (CT1, CT2, CT3) -->
          @if (col.field === 'ct1' || col.field === 'ct2' || col.field === 'ct3') {
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input pInputText type="number" step="0.1" [(ngModel)]="rowData[col.field]"
                (ngModelChange)="calcularMedias(rowData)" class="w-full" [placeholder]="'Ingrese valor CT'" min="0"
                [class.p-invalid]="!esValorValido(rowData[col.field]) && rowData[col.field] !== null && rowData[col.field] !== ''"
                pTooltip="Al menos 2 de los 3 valores CT deben estar completos" tooltipPosition="top"
                autocomplete="off">
            </ng-template>
            <ng-template pTemplate="output">
              <span [class.text-gray-400]="rowData[col.field] === null || rowData[col.field] === ''">
                {{ rowData[col.field] !== null && rowData[col.field] !== '' ? rowData[col.field] : 'Sin dato' }}
              </span>
            </ng-template>
          </p-cellEditor>
          }

          <!-- MEDIA CT -->
          @else if (col.field === 'media_ct') {
          <span class="font-semibold text-blue-600">
            {{ rowData.media_ct !== null ? (rowData.media_ct | number:'1.1-2') : 'Sin dato' }}
          </span>
          }

          <!-- CAMPOS CC (CC1, CC2, CC3) -->
          @else if (col.field === 'cc1' || col.field === 'cc2' || col.field === 'cc3') {
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input pInputText type="number" step="0.1" [(ngModel)]="rowData[col.field]"
                (ngModelChange)="calcularMedias(rowData)" class="w-full" [placeholder]="'Ingrese valor CC'" min="0"
                [class.p-invalid]="!esValorValido(rowData[col.field]) && rowData[col.field] !== null && rowData[col.field] !== ''"
                pTooltip="Al menos 2 de los 3 valores CC deben estar completos" tooltipPosition="top"
                autocomplete="off">
            </ng-template>
            <ng-template pTemplate="output">
              <span [class.text-gray-400]="rowData[col.field] === null || rowData[col.field] === ''">
                {{ rowData[col.field] !== null && rowData[col.field] !== '' ? rowData[col.field] : 'Sin dato' }}
              </span>
            </ng-template>
          </p-cellEditor>
          }

          <!-- MEDIA CC -->
          @else if (col.field === 'media_cc') {
          <span class="font-semibold text-green-600">
            {{ rowData.media_cc !== null ? (rowData.media_cc | number:'1.1-2') : 'Sin dato' }}
          </span>
          }

          <!-- KCAL/L (CALCULADO AUTOMÁTICAMENTE) -->
          @else if (col.field === 'kcal_l') {
          <div class="flex items-center justify-center">
            <span class="font-semibold text-purple-600" [class.text-gray-400]="rowData.kcal_l === null">
              {{ rowData.kcal_l !== null ? rowData.kcal_l : 'Sin datos' }}
            </span>
          </div>
          }

          <!-- ACCIONES -->
          @else if (col.field === 'acciones') {
          <div class="flex items-center justify-center gap-2">
            <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow icon="pi pi-pencil" text rounded
              severity="secondary" (click)="onRowEditInit(rowData)" pTooltip="Editar" tooltipPosition="top">
            </button>

            <button *ngIf="editing" pButton pRipple type="button" icon="pi pi-check" text rounded severity="success"
              (click)="onRowEditSave(rowData, rowIndex, $event)" pTooltip="Guardar" tooltipPosition="top">
            </button>

            <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow icon="pi pi-times" text rounded
              severity="danger" (click)="onRowEditCancel(rowData, rowIndex)" pTooltip="Cancelar" tooltipPosition="top">
            </button>
          </div>
          }

          @else {
          {{ rowData[col.field] }}
          }
        </td>
        }
      </tr>
    </ng-template>
  </p-table>

  @if (!dataCrematocrito || dataCrematocrito.length === 0) {
  <p class="text-gray-400 text-center italic mt-4">No hay datos para mostrar</p>
  }

  <!-- Nota informativa mejorada -->
  <!-- <div class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-green-50 border border-blue-200 rounded-lg text-sm">
    <div class="flex items-start gap-3">
      <i class="pi pi-info-circle text-blue-600 mt-1"></i>
      <div>
        <p class="font-semibold text-gray-800 mb-2">Información importante:</p>
        <ul class="space-y-1 text-gray-700">
          <li>• <strong>Campos requeridos:</strong> Mínimo 2 valores CT y 2 valores CC</li>
          <li>• <strong>Campos opcionales:</strong> Puede dejar máximo 1 campo CT y 1 campo CC vacíos</li>
          <li>• <strong>Fórmula KCAL/L:</strong> (Media CC × 100) ÷ Media CT × 66.8 + 290</li>
          <li>• <strong>Valores vacíos:</strong> Se guardan como null en la base de datos</li>
        </ul>
      </div>
    </div>
  </div> -->
</div>
