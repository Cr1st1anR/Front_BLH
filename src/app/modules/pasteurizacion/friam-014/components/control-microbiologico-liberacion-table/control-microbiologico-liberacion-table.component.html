<p-toast position="top-right" key="tr" />

@if (loading.main) {
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
  <p-progress-spinner strokeWidth="8" fill="transparent" animationDuration="2s"
    [style]="{ width: '70px', height: '70px' }"></p-progress-spinner>
</div>
}

<div class="container-table">
  <!-- Sección de búsqueda por ciclo y lote -->
  <div class="search-section">
    <div class="flex items-center gap-4">
      <span class="font-semibold text-gray-700">CICLO DE PASTEURIZACIÓN:</span>

      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-600">Ciclo:</label>
        <input pInputText type="number" [(ngModel)]="busquedaCicloLote.ciclo" class="w-20 p-2" min="1" step="1" />
      </div>

      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-600">Lote:</label>
        <input pInputText type="number" [(ngModel)]="busquedaCicloLote.lote" class="w-20 p-2" min="1" step="1" />
      </div>

      <button pButton pRipple type="button" icon="pi pi-search" label="Buscar" class="search-button p-button-sm"
        (click)="buscarFrascosPorCicloLote()" [disabled]="loading.search">
      </button>

      <button pButton pRipple type="button" icon="pi pi-times" label="Limpiar" class="clear-button p-button-sm"
        (click)="limpiarBusqueda()">
      </button>

      @if (loading.search) {
      <div class="flex items-center gap-2 ml-4">
        <p-progress-spinner [style]="{ width: '20px', height: '20px' }" strokeWidth="4"></p-progress-spinner>
        <span class="text-sm text-gray-500">Buscando...</span>
      </div>
      }
    </div>

    @if (fechaPasteurizacion) {
    <div class="mt-3 p-2 bg-blue-50 rounded border-l-4 border-blue-400">
      <span class="text-sm font-medium text-blue-700">FECHA DE PASTEURIZACIÓN: </span>
      <span class="text-sm text-blue-600">{{ fechaPasteurizacion | date:'dd/MM/yyyy' }}</span>
    </div>
    }
  </div>

  <!-- Tabla -->
  <p-table #tableControlMicrobiologico [value]="dataControlMicrobiologico" [scrollable]="true" scrollHeight="400px"
    [columns]="headersControlMicrobiologico" [tableStyle]="{ 'min-width': '70rem' }" dataKey="id" editMode="row">

    <ng-template #header let-columns>
      <tr>
        @for (col of columns; track $index) {
        <th [style.width]="col.width" [style.min-width]="col.width" class="text-center table-header">
          <div [innerHTML]="col.header" class="whitespace-pre-line text-sm leading-tight font-medium"></div>
        </th>
        }
      </tr>
    </ng-template>

    <ng-template #body let-rowData let-columns="columns" let-editing="editing" let-rowIndex="rowIndex">
      <tr [pEditableRow]="rowData" [style.cursor]="'default'">
        @for (col of columns; track $index) {
        <td [style.width]="col.width" [style.min-width]="col.width" class="text-center table-cell">

          @if (col.field === 'numero_frasco_pasteurizado') {
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input pInputText type="text" [(ngModel)]="rowData.numero_frasco_pasteurizado"
                class="w-full text-center table-input" [disabled]="true" [readonly]="true">
            </ng-template>
            <ng-template pTemplate="output">
              <span class="table-text">{{ rowData.numero_frasco_pasteurizado || 'Sin número' }}</span>
            </ng-template>
          </p-cellEditor>
          }

          @else if (col.field === 'coliformes_totales') {
          <p-cellEditor>
            <ng-template pTemplate="input">
              <div class="radio-container-horizontal">
                <div class="radio-option">
                  <p-radiobutton name="coliformes_{{rowIndex}}" [value]="1" [(ngModel)]="rowData.coliformes_totales"
                    inputId="coliformes_a_{{rowIndex}}" />
                  <label for="coliformes_a_{{rowIndex}}" class="radio-label">A</label>
                </div>
                <div class="radio-option">
                  <p-radiobutton name="coliformes_{{rowIndex}}" [value]="0" [(ngModel)]="rowData.coliformes_totales"
                    inputId="coliformes_p_{{rowIndex}}" />
                  <label for="coliformes_p_{{rowIndex}}" class="radio-label">P</label>
                </div>
              </div>
            </ng-template>
            <ng-template pTemplate="output">
              <span class="table-text">{{ getDisplayValueColiformes(rowData.coliformes_totales) }}</span>
            </ng-template>
          </p-cellEditor>
          }

          @else if (col.field === 'conformidad') {
          <p-cellEditor>
            <ng-template pTemplate="input">
              <div class="radio-container-horizontal">
                <div class="radio-option">
                  <p-radiobutton name="conformidad_{{rowIndex}}" [value]="1" [(ngModel)]="rowData.conformidad"
                    inputId="conformidad_c_{{rowIndex}}" />
                  <label for="conformidad_c_{{rowIndex}}" class="radio-label">C</label>
                </div>
                <div class="radio-option">
                  <p-radiobutton name="conformidad_{{rowIndex}}" [value]="0" [(ngModel)]="rowData.conformidad"
                    inputId="conformidad_nc_{{rowIndex}}" />
                  <label for="conformidad_nc_{{rowIndex}}" class="radio-label">NC</label>
                </div>
              </div>
            </ng-template>
            <ng-template pTemplate="output">
              <span class="table-text">{{ getDisplayValueConformidad(rowData.conformidad) }}</span>
            </ng-template>
          </p-cellEditor>
          }

          @else if (col.field === 'prueba_confirmatoria') {
          <p-cellEditor>
            <ng-template pTemplate="input">
              <div class="radio-container-centered">
                <div class="radio-option">
                  <p-radiobutton name="prueba_{{rowIndex}}" value="PC" [(ngModel)]="rowData.prueba_confirmatoria"
                    inputId="prueba_pc_{{rowIndex}}" />
                  <label for="prueba_pc_{{rowIndex}}" class="radio-label">PC</label>
                </div>
              </div>
            </ng-template>
            <ng-template pTemplate="output">
              <span class="table-text">{{ rowData.prueba_confirmatoria || 'No seleccionado' }}</span>
            </ng-template>
          </p-cellEditor>
          }

          @else if (col.field === 'liberacion_producto') {
          <p-cellEditor>
            <ng-template pTemplate="input">
              <div class="radio-container-horizontal">
                <div class="radio-option">
                  <p-radiobutton name="liberacion_{{rowIndex}}" [value]="1" [(ngModel)]="rowData.liberacion_producto"
                    inputId="liberacion_si_{{rowIndex}}" />
                  <label for="liberacion_si_{{rowIndex}}" class="radio-label">Sí</label>
                </div>
                <div class="radio-option">
                  <p-radiobutton name="liberacion_{{rowIndex}}" [value]="0" [(ngModel)]="rowData.liberacion_producto"
                    inputId="liberacion_no_{{rowIndex}}" />
                  <label for="liberacion_no_{{rowIndex}}" class="radio-label">No</label>
                </div>
              </div>
            </ng-template>
            <ng-template pTemplate="output">
              <span class="table-text">{{ getDisplayValueLiberacion(rowData.liberacion_producto) }}</span>
            </ng-template>
          </p-cellEditor>
          }

          @else if (col.field === 'acciones') {
          <div class="flex items-center justify-center gap-2">
            <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow icon="pi pi-pencil" text rounded
              severity="secondary" (click)="onRowEditInit(rowData)" [disabled]="isEditButtonDisabled(rowData)"
              pTooltip="Editar" tooltipPosition="top">
            </button>

            <button *ngIf="editing" pButton pRipple type="button" icon="pi pi-check" text rounded severity="success"
              (click)="onRowEditSave(rowData, rowIndex, $event)" pTooltip="Guardar" tooltipPosition="top">
            </button>

            <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow icon="pi pi-times" text rounded
              severity="danger" (click)="onRowEditCancel(rowData, rowIndex)" pTooltip="Cancelar" tooltipPosition="top">
            </button>
          </div>
          }

        </td>
        }
      </tr>
    </ng-template>
  </p-table>

  @if (!dataControlMicrobiologico || dataControlMicrobiologico.length === 0) {
  <p class="text-gray-400 text-center italic mt-4">
    Utilice la búsqueda por ciclo y lote para cargar los frascos pasteurizados
  </p>
  }
</div>
